name: Waifu2x Telegram Instant
on: [workflow_dispatch]

jobs:
  process:
    runs-on: ubuntu-latest
    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y golang jq curl git

      - name: Build Waifu2x-Go
        run: |
          git clone https://github.com/ikawaha/waifu2x.go.git
          cd waifu2x.go
          go build -o waifu2x main.go
          sudo mv waifu2x /usr/local/bin/
          cd ..
          rm -rf waifu2x.go

      - name: Start Local Bot API
        env:
          TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
          TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        run: |
          mkdir -p /tmp/telegram-data
          docker run -d --name telegram-bot-api \
            -p 8081:8081 \
            -v /tmp/telegram-data:/var/lib/telegram-bot-api \
            -e TELEGRAM_API_ID=${TELEGRAM_API_ID} \
            -e TELEGRAM_API_HASH=${TELEGRAM_API_HASH} \
            -e TELEGRAM_LOCAL=1 \
            aiogram/telegram-bot-api:latest
          sleep 10

      - name: Execute Upscale and Exit
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "Buscando último archivo en el historial..."
          RESPONSE=$(curl -s "http://localhost:8081/bot${TELEGRAM_BOT_TOKEN}/getUpdates?offset=-1")
          
          UPDATE=$(echo "$RESPONSE" | jq -r ".result | map(select(.message.from.id == ${TELEGRAM_CHAT_ID} and (.message.document != null or .message.photo != null))) | last")
          
          if [ "$UPDATE" == "null" ] || [ "$UPDATE" == "" ]; then
            echo "Error: No se encontró archivo. Asegúrate de haber enviado la foto antes de correr la Action."
            exit 1
          fi

          FILE_ID=$(echo "$UPDATE" | jq -r '.message.document.file_id // .message.photo[-1].file_id')
          
          FILE_INFO=$(curl -s "http://localhost:8081/bot${TELEGRAM_BOT_TOKEN}/getFile?file_id=${FILE_ID}")
          FILE_PATH=$(echo "$FILE_INFO" | jq -r '.result.file_path')

          echo "Ruta detectada en contenedor: $FILE_PATH"
          
          # Copiamos directamente desde el volumen montado para evitar errores de curl
          cp "/tmp/telegram-data/bot${TELEGRAM_BOT_TOKEN}/${FILE_PATH}" ./input.jpg
          
          if [ -s "input.jpg" ]; then
            echo "Iniciando waifu2x..."
            waifu2x -i input.jpg -o output.png -n 2 -s 2
            
            echo "Enviando resultado..."
            curl -s -X POST "http://localhost:8081/bot${TELEGRAM_BOT_TOKEN}/sendDocument" \
              -F chat_id=${TELEGRAM_CHAT_ID} \
              -F document=@"output.png" \
              -F caption="✅ Escalado completado"
            
            echo "Proceso finalizado."
          else
            echo "Error: El archivo copiado está vacío o no existe."
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          docker stop telegram-bot-api
          docker rm telegram-bot-api
          rm -rf /tmp/telegram-data
          rm -f input.jpg output.png