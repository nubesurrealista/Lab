name: Waifu2x Telegram Live Session
on: [workflow_dispatch]

jobs:
  process:
    runs-on: ubuntu-latest
    steps:
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y golang jq curl git file

      - name: Build Waifu2x-Go
        run: |
          git clone https://github.com/ikawaha/waifu2x.go.git
          cd waifu2x.go
          go build -o waifu2x main.go
          sudo mv waifu2x /usr/local/bin/
          cd ..
          rm -rf waifu2x.go

      - name: Start Local Bot API
        env:
          TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
          TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
        run: |
          mkdir -p /tmp/telegram-data
          docker run -d --name telegram-bot-api \
            -p 8081:8081 \
            -v /tmp/telegram-data:/var/lib/telegram-bot-api \
            -e TELEGRAM_API_ID=${TELEGRAM_API_ID} \
            -e TELEGRAM_API_HASH=${TELEGRAM_API_HASH} \
            -e TELEGRAM_LOCAL=1 \
            aiogram/telegram-bot-api:latest
          sleep 10

      - name: Live Processing Loop
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          LAST_UPDATE_ID=0
          END_TIME=$((SECONDS + 600))
          echo "Bot activo. Esperando imágenes..."

          while [ $SECONDS -lt $END_TIME ]; do
            RESPONSE=$(curl -s "http://localhost:8081/bot${TELEGRAM_BOT_TOKEN}/getUpdates?offset=${LAST_UPDATE_ID}&timeout=20")
            UPDATE=$(echo "$RESPONSE" | jq -r ".result | map(select(.message.from.id | tostring == \"$TELEGRAM_CHAT_ID\")) | last")

            if [ "$UPDATE" != "null" ] && [ "$UPDATE" != "" ]; then
              UPDATE_ID=$(echo "$UPDATE" | jq -r '.update_id')
              LAST_UPDATE_ID=$((UPDATE_ID + 1))
              
              FILE_ID=$(echo "$UPDATE" | jq -r '.message.document.file_id // .message.photo[-1].file_id // empty')
              CAPTION=$(echo "$UPDATE" | jq -r '.message.caption // ""' | tr '[:upper:]' '[:lower:]')

              if [ ! -z "$FILE_ID" ] && [[ "$CAPTION" != *"✅"* ]]; then
                FILE_INFO=$(curl -s "http://localhost:8081/bot${TELEGRAM_BOT_TOKEN}/getFile?file_id=${FILE_ID}")
                RAW_PATH=$(echo "$FILE_INFO" | jq -r '.result.file_path')
                
                CLEAN_PATH=$(echo "$RAW_PATH" | rev | cut -d'/' -f1,2 | rev)
                FULL_PATH="/tmp/telegram-data/bot${TELEGRAM_BOT_TOKEN}/${CLEAN_PATH}"
                
                sudo cp "$FULL_PATH" ./input_file
                sudo chown $USER:$USER ./input_file

                MIME_TYPE=$(file --mime-type -b ./input_file)
                EXT="jpg"; [[ "$MIME_TYPE" == "image/png" ]] && EXT="png"
                mv input_file "input.$EXT"

                MODE="anime"; NOISE="2"; SCALE="2.0"
                [[ "$CAPTION" == *"photo"* ]] && MODE="photo"
                [[ "$CAPTION" =~ -s\ ([0-9.]+) ]] && SCALE="${BASH_REMATCH[1]}"
                [[ "$CAPTION" =~ -n\ ([0-3]) ]] && NOISE="${BASH_REMATCH[1]}"

                waifu2x -v -i "input.$EXT" -o output.png -m "$MODE" -n "$NOISE" -s "$SCALE"

                curl -s -X POST "http://localhost:8081/bot${TELEGRAM_BOT_TOKEN}/sendDocument" \
                  -F chat_id=${TELEGRAM_CHAT_ID} \
                  -F document=@"output.png" \
                  -F caption="✅ Modo: $MODE | Ruido: $NOISE | Escala: $SCALE"

                rm -f "input.$EXT" output.png
              fi
            fi
          done

      - name: Cleanup
        if: always()
        run: |
          docker stop telegram-bot-api || true
          docker rm telegram-bot-api || true
          sudo rm -rf /tmp/telegram-data
