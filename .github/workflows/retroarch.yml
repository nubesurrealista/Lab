name: Build RetroArch for Alpine (Extreme Core 2 Duo Optimization)
on:
  workflow_dispatch: null

jobs:
  build:
    runs-on: ubuntu-latest
    container: alpine:latest
    steps:
      - name: Install dependencies (Alpine/Musl)
        run: |
          apk update
          apk add build-base clang lld git curl jq tar xz p7zip \
                  mesa-dev alsa-lib-dev freetype-dev libx11-dev \
                  libxinerama-dev libxxf86vm-dev libxkbcommon-dev \
                  libxml2-dev libusb-dev eudev-dev sdl2-dev \
                  libxv-dev mesa-gles

      - name: Get latest RetroArch source
        run: |
          LATEST_RELEASE=$(curl -sL https://api.github.com/repos/libretro/RetroArch/releases/latest)
          ASSET_URL=$(echo "$LATEST_RELEASE" | jq -r '.assets[] | select(.name | startswith("retroarch-sourceonly-") and endswith(".tar.xz")) | .browser_download_url')
          wget "$ASSET_URL" -O source.tar.xz
          mkdir retroarch && tar -xvf source.tar.xz -C retroarch --strip-components=1

      - name: Configure and build with Clang (Hardware Targeted)
        env:
          CC: clang
          CXX: clang++
          # Optimizaciones específicas para Core 2 Duo y Musl
          # Usamos -O2 porque -Oz a veces causa stuttering en audio en CPUs viejos
          CFLAGS: -O2 -march=core2 -mtune=core2 -pipe -flto=thin -fno-stack-protector
          CXXFLAGS: -O2 -march=core2 -mtune=core2 -pipe -flto=thin -fno-stack-protector
          LDFLAGS: -fuse-ld=lld -Wl,--gc-sections -flto=thin
        run: |
          cd retroarch
          
          # Forzamos XVideo y SDL2, deshabilitamos todo lo que requiere GPU moderna (Vulkan/Wayland)
          ./configure \
            --disable-debug \
            --disable-vulkan \
            --disable-wayland \
            --disable-ffmpeg \
            --disable-qt \
            --disable-xmb \
            --disable-ozone \
            --disable-materialui \
            --disable-cheevos \
            --disable-discord \
            --disable-overlay \
            --disable-network_video \
            --disable-videoprocessor \
            --enable-xvideo \
            --enable-sdl2 \
            --enable-alsa \
            --enable-udev \
            --enable-kms \
            --enable-egl \
            --enable-zlib \
            --prefix=/usr

          make -j$(nproc)

      - name: Strip and Compress
        run: |
          strip --strip-unneeded retroarch/retroarch
          echo "Tamaño final del binario:"
          du -h retroarch/retroarch

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: retroarch-alpine-core2duo
          path: retroarch/retroarch
          retention-days: 1
