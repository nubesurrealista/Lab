name: Build RetroArch for Alpine (Musl Optimized)
on:
  workflow_dispatch: null
jobs:
  build:
    runs-on: ubuntu-latest
    container: alpine:latest  # Cambiamos a Alpine
    steps:
      - name: Install dependencies (Alpine style)
        run: |
          apk update
          apk add build-base clang lld git curl jq tar xz p7zip \
                  mesa-dev alsa-lib-dev freetype-dev libx11-dev \
                  libxinerama-dev libxxf86vm-dev libxkbcommon-dev \
                  libxml2-dev libusb-dev udev-dev sdl2-dev \
                  libxv-dev  # <--- CRUCIAL para el soporte XVideo

      - name: Get latest RetroArch source
        run: |
          LATEST_RELEASE=$(curl -sL https://api.github.com/repos/libretro/RetroArch/releases/latest)
          ASSET_URL=$(echo "$LATEST_RELEASE" | jq -r '.assets[] | select(.name | startswith("retroarch-sourceonly-") and endswith(".tar.xz")) | .browser_download_url')
          wget "$ASSET_URL" -O source.tar.xz
          mkdir retroarch && tar -xvf source.tar.xz -C retroarch --strip-components=1

      - name: Configure and build
        env:
          CC: clang
          CXX: clang++
          # Cambiamos -Oz por -O2 o -O3; -Oz a veces rompe el rendimiento en emulación
          CFLAGS: -O2 -march=core2 -pipe -flto=thin
          LDFLAGS: -fuse-ld=lld -flto=thin
        run: |
          cd retroarch
          # Eliminamos --disable-kms (podría servirte luego) 
          # Añadimos --enable-xvideo
          ./configure \
            --disable-vulkan --disable-ffmpeg --disable-wayland \
            --disable-qt --disable-xmb --disable-ozone --disable-materialui \
            --disable-discord --disable-cheevos --disable-overlay \
            --enable-xvideo --enable-sdl2 --enable-alsa \
            --disable-debug
          make -j$(nproc)

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: retroarch-alpine-native
          path: retroarch/retroarch
