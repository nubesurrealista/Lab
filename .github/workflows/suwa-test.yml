name: Build Ultra-Light Visor
on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev libsoup2.4-dev

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Init Project and Build
        run: |
          cargo init --name suwayomi-visor
          echo 'wry = "0.35"' >> Cargo.toml
          
          cat << 'EOF' > src/main.rs
          use wry::{
              application::{
                  event::{Event, StartCause, WindowEvent},
                  event_loop::{ControlFlow, EventLoop},
                  window::WindowBuilder,
              },
              webview::WebViewBuilder,
          };

          fn main() -> wry::Result<()> {
              let event_loop = EventLoop::new();
              let window = WindowBuilder::new()
                  .with_title("Suwayomi")
                  .with_inner_size(wry::application::dpi::LogicalSize::new(1000.0, 800.0))
                  .build(&event_loop)
                  .unwrap();

              let _webview = WebViewBuilder::new(window)?
                  .with_url("http://127.0.0.1:4567")?
                  .build()?;

              event_loop.run(move |event, _, control_flow| {
                  *control_flow = ControlFlow::Wait;
                  match event {
                      Event::NewEvents(StartCause::Init) => (),
                      Event::WindowEvent {
                          event: WindowEvent::CloseRequested,
                          ..
                      } => *control_flow = ControlFlow::Exit,
                      _ => (),
                  }
              });
          }
          EOF

          cargo build --release

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: visor-binary
          path: target/release/suwayomi-visor
