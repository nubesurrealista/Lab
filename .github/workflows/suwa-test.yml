name: Build Suwayomi Native Visor

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container: alpine:latest
    steps:
      - name: Install dependencies
        run: |
          apk add build-base webkit2gtk4-dev gtk+3.0-dev pkgconf

      - name: Create source code
        run: |
          cat << 'EOF' > suwayomi.c
          #include <gtk/gtk.h>
          #include <webkit2/webkit2.h>

          int main(int argc, char *argv[]) {
              gtk_init(&argc, &argv);
              GtkWidget *win = gtk_window_new(GTK_WINDOW_TOPLEVEL);
              gtk_window_set_title(GTK_WINDOW(win), "Suwayomi");
              gtk_window_set_default_size(GTK_WINDOW(win), 1280, 720);
              
              GtkWidget *web = webkit_web_view_new();
              WebKitSettings *settings = webkit_web_view_get_settings(WEBKIT_WEB_VIEW(web));
              
              webkit_settings_set_enable_javascript(settings, TRUE);
              
              gtk_container_add(GTK_CONTAINER(win), web);
              webkit_web_view_load_uri(WEBKIT_WEB_VIEW(web), "http://127.0.0.1:4567");
              
              g_signal_connect(win, "destroy", G_CALLBACK(gtk_main_quit), NULL);
              gtk_widget_show_all(win);
              gtk_main();
              return 0;
          }
          EOF

      - name: Compile binary
        run: |
          gcc suwayomi.c -o suwayomi $(pkgconf --cflags --libs gtk+-3.0 webkit2gtk-4.0)

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: suwayomi-musl
          path: suwayomi
