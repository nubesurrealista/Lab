---
name: Kumo Reproducibility Check (Dual-Build Isolation)
on:
  workflow_dispatch: null
jobs:
  repro-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v6
      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: '21'
      - name: Clone Source for Build A
        run: git clone --depth 1 https://github.com/nubesurrealista/Kumo.git Kumo_A
      - name: Run Build A
        run: |
          cd Kumo_A
          export GRADLE_USER_HOME=$HOME/.gradle_a
          chmod +x gradlew
          ./gradlew assembleRelease
          mkdir -p ../build_outputs
          cp app/build/outputs/apk/release/app-arm64-v8a-release-unsigned.apk ../build_outputs/build_a.apk
      - name: Clone Source for Build B
        run: git clone --depth 1 https://github.com/nubesurrealista/Kumo.git Kumo_B
      - name: Run Build B (Isolated)
        run: |
          cd Kumo_B
          export GRADLE_USER_HOME=$HOME/.gradle_b
          chmod +x gradlew
          ./gradlew assembleRelease
          mkdir -p ../build_outputs
          cp app/build/outputs/apk/release/app-arm64-v8a-release-unsigned.apk ../build_outputs/build_b.apk
      - name: Install Analysis Tools
        run: |
          sudo apt update
          sudo apt install -y diffoscope apktool
      - name: Compare APKs
        id: compare
        run: |
          echo "Comparando hashes SHA256..."
          sha256sum build_outputs/build_a.apk build_outputs/build_b.apk

          echo "Ejecutando Diffoscope para validación bit a bit..."
          if diffoscope --html report.html build_outputs/build_a.apk build_outputs/build_b.apk; then
            echo "**********************************************************"
            echo "REPRODUCIBILIDAD CONFIRMADA: LOS APKS SON IDÉNTICOS"
            echo "**********************************************************"
          else
            echo "**********************************************************"
            echo "FALLO: SE ENCONTRARON DIFERENCIAS EN LAS BUILDS"
            echo "**********************************************************"
            exit 1
          fi
      - name: Upload Comparison Report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: reproducibility-report
          path: report.html
