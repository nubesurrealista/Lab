name: Build IceWM

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container: debian:bookworm

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          apt-get update -y
          apt-get install -y \
            git \
            build-essential \
            cmake \
            pkg-config \
            libimlib2-dev \
            libxcomposite-dev \
            libxdamage-dev \
            libxfixes-dev \
            libxft-dev \
            libxinerama-dev \
            libxpm-dev \
            libxrandr-dev \
            libxrender-dev \
            asciidoctor \
            perl \
            libjpeg-dev \
            libpng-dev \
            librsvg2-dev \
            gettext \
            libfribidi-dev \
            libxcursor-dev \
            libsm-dev \
            libx11-dev \
            libxext-dev \
            xorg-dev \
            libgdk-pixbuf2.0-dev \
            libglib2.0-dev

      - name: Clone IceWM repository
        run: git clone https://github.com/ice-wm/icewm.git

      - name: Create Build Environment
        run: mkdir -p build

      - name: Configure CMake
        working-directory: ./build
        run: |
          cmake ../icewm \
            -D CMAKE_INSTALL_PREFIX=/usr \
            -D CMAKE_BUILD_TYPE=Release \
            -D CFGDIR=/etc \
            -D ENABLE_LTO=ON \
            -D DOCDIR=/usr/share/doc \
            -D CONFIG_XRES=OFF

      - name: Build
        working-directory: ./build
        run: make -j$(nproc)

      - name: Install to staging directory
        working-directory: ./build
        run: |
          mkdir /staging
          make DESTDIR=/staging install

      - name: Create clean tarball
        run: |
          cd /staging
          tar -czf /icewm-binaries.tar.gz .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: icewm-binaries
          path: /icewm-binaries.tar.gz
