name: Build TIC-80 PRO (v1.1.2837) on Alpine

on:
  workflow_dispatch:

jobs:
  build-alpine:
    runs-on: ubuntu-latest
    container:
      image: alpine:latest
      options: --user root

    steps:
      - name: Install build dependencies
        run: |
          apk update
          apk add --no-cache \
            build-base \
            cmake \
            git \
            ruby-dev \
            sdl2-dev \
            mesa-dev \
            glu-dev \
            freeglut-dev \
            curl-dev \
            ca-certificates \
            doas \
            libx11-dev \
            libxext-dev \
            libxcursor-dev \
            libxinerama-dev \
            libxrandr-dev \
            libxi-dev

      - name: Clone TIC-80 stable release v1.1.2837
        run: |
          git clone --recursive --branch v1.1.2837 https://github.com/nesbox/TIC-80.git

      - name: Configure CMake
        run: |
          mkdir -p TIC-80/build
          cd TIC-80/build
          cmake -DCMAKE_POLICY_VERSION_MINIMUM=3.5 \
                -DBUILD_PRO=On \
                -DBUILD_SDLGPU=On \
                -DBUILD_WITH_ALL=On \
                -DCMAKE_BUILD_TYPE=Release \
                ..

      - name: Compile
        run: |
          cd TIC-80/build
          make -j$(nproc)

      - name: Locate and prepare final binary
        id: locate
        run: |
          BINARY=$(find TIC-80/build -type f -executable -name tic80 | head -1)
          if [ -z "$BINARY" ]; then
            exit 1
          fi
          cp "$BINARY" ./tic80-pro-alpine-x11
          strip --strip-unneeded ./tic80-pro-alpine-x11
          echo "binary_path=./tic80-pro-alpine-x11" >> $GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tic80-pro-alpine-x11
          path: ${{ steps.locate.outputs.binary_path }}
          retention-days: 1
