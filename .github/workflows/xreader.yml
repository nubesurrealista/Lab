name: Build xreader on Debian 12
on: workflow_dispatch
jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: debian:12
      options: --privileged

    steps:
      - name: Install base tools and dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          apt-get update
          apt-get install -y \
            git \
            devscripts \
            equivs \
            build-essential \
            fakeroot \
            debhelper \
            sudo \
            ca-certificates \
            wget \
            dpkg-dev \
            curl \
            perl \
            # xapps-common deps (except inxi)
            python3-gi \
            python3-gi-cairo \
            xdg-utils \
            dconf-gsettings-backend \
            # xreader build deps
            libgtk-3-dev \
            libglib2.0-dev \
            libpoppler-glib-dev \
            libdjvulibre-dev \
            libspectre-dev \
            libtiff-dev \
            libwebp-dev \
            libcairo2-dev \
            libxml2-dev \
            valac \
            gobject-introspection \
            libgirepository1.0-dev \
            libcaja-extension-dev \
            libpango1.0-dev \
            librsvg2-dev

      - name: Install inxi manually (from official source)
        run: |
          # Descargar inxi desde su sitio oficial
          wget -q https://github.com/smxi/inxi/raw/master/inxi -O /usr/local/bin/inxi
          chmod +x /usr/local/bin/inxi
          # Verificar
          inxi --version && echo "inxi installed successfully"

      - name: Download and install xapps packages (exact order)
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          set -e

          # 1. xapps-common
          wget -q http://packages.linuxmint.com/pool/backport/x/xapp/xapps-common_2.4.2+vera_all.deb
          dpkg -i xapps-common_2.4.2+vera_all.deb || apt-get install -f -y

          # 2. libxapp1
          wget -q http://packages.linuxmint.com/pool/backport/x/xapp/libxapp1_2.4.2+vera_amd64.deb
          dpkg -i libxapp1_2.4.2+vera_amd64.deb || apt-get install -f -y

          # 3. gir1.2-xapp-1.0
          wget -q http://packages.linuxmint.com/pool/backport/x/xapp/gir1.2-xapp-1.0_2.4.2+vera_amd64.deb
          dpkg -i gir1.2-xapp-1.0_2.4.2+vera_amd64.deb || apt-get install -f -y

          # 4. libxapp-dev
          wget -q http://packages.linuxmint.com/pool/backport/x/xapp/libxapp-dev_2.4.2+vera_amd64.deb
          dpkg -i libxapp-dev_2.4.2+vera_amd64.deb || apt-get install -f -y

          # Final fix
          apt-get install -f -y

          # Cleanup
          rm -f *.deb

          echo "xapps dependencies installed successfully."

      - name: Checkout xreader
        uses: actions/checkout@v4
        with:
          repository: linuxmint/xreader
          path: xreader

      - name: Install xreader build dependencies
        working-directory: ./xreader
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          mk-build-deps -i -t "apt-get -y --no-install-recommends" debian/control || apt-get install -f -y

      - name: Build xreader
        working-directory: ./xreader
        run: |
          dpkg-buildpackage -us -uc -b

      - name: List generated packages
        run: |
          echo "=== Generated .deb files ==="
          find .. -name "*.deb" -o -name "*.changes" -o -name "*.buildinfo" | sort

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: xreader-debs-debian12
          path: |
            ../*.deb
            ../*.changes
            ../*.buildinfo
          if-no-files-found: error
          retention-days: 30
