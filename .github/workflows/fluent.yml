name: Manual Build Universal Flatpak

on:
  workflow_dispatch:

jobs:
  build_flatpak:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Build Environment
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder binutils
          flatpak remote-add --user --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

      - name: Build Official Debian Package
        run: |
          git clone --depth 1 https://github.com/FluentFlame/fluentflame-reader.git source-code
          cd source-code
          npm install
          npm run build
          npm run package-deb
          find . -name "*.deb" -exec cp {} ../package.deb \;
          cd ..

      - name: Create Flatpak Manifest
        run: |
          cat <<EOF > org.fluentflame.Reader.yml
          app-id: org.fluentflame.Reader
          runtime: org.freedesktop.Platform
          runtime-version: '24.08'
          sdk: org.freedesktop.Sdk
          command: fluentflame-reader
          finish-args:
            - --share=ipc
            - --socket=wayland
            - --socket=fallback-x11
            - --device=dri
            - --socket=pulseaudio
            - --share=network
            - --filesystem=home
          modules:
            - name: reader-deb-extractor
              buildsystem: simple
              build-commands:
                - ar x package.deb
                - tar xf data.tar.*
                - if [ -d opt ]; then cp -r opt/* /app/; fi
                - if [ -d usr ]; then cp -r usr/* /app/; fi
                
                - rm -rf /app/share/doc /app/share/man /app/share/info
                - find /app -name "*.a" -delete
                - find /app -name "*.h" -delete
                
                - find /app -type f -name "*.so*" -exec strip --strip-unneeded {} + || true
                - find /app -type f -executable -exec strip --strip-unneeded {} + || true

                - mkdir -p /app/bin
                - find /app -name "fluentflame-reader" -type f -executable -exec ln -s {} /app/bin/fluentflame-reader \;
                
                - mkdir -p /app/share/applications
                - find . -name "*.desktop" -exec cp {} /app/share/applications/org.fluentflame.Reader.desktop \;
                - sed -i 's/Exec=.*/Exec=fluentflame-reader --no-sandbox --ozone-platform-hint=auto/' /app/share/applications/org.fluentflame.Reader.desktop
                - sed -i 's/Icon=.*/Icon=org.fluentflame.Reader/' /app/share/applications/org.fluentflame.Reader.desktop
                
                - mkdir -p /app/share/icons/hicolor/512x512/apps/
                - find . -name "fluentflame-reader.png" -exec cp {} /app/share/icons/hicolor/512x512/apps/org.fluentflame.Reader.png \;
              sources:
                - type: file
                  path: package.deb
          EOF

      - name: Build Flatpak Bundle
        run: |
          flatpak-builder --user --install-deps-from=flathub --disable-rofiles-fuse --force-clean --repo=repo build_dir org.fluentflame.Reader.yml
          flatpak build-bundle repo FluentFlame-Personal.flatpak org.fluentflame.Reader

      - name: Upload Artifact
        uses: actions/upload-artifact@v6
        with:
          name: FluentFlame-Final-Bundle
          path: FluentFlame-Personal.flatpak
