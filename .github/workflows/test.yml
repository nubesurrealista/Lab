name: Media Handler Task
on:
  workflow_dispatch:

jobs:
  stage:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Environment
        run: |
          echo "::add-mask::${{ secrets.SOURCE_ENTRY }}"
          sudo apt update && sudo apt install -y aria2 ffmpeg zip parallel
          mkdir -p payload final

      - name: Download Media
        run: |
          aria2c --seed-time=0 --dir=./payload --max-connection-per-server=16 \
                 --summary-interval=0 --console-log-level=error \
                 "${{ secrets.SOURCE_ENTRY }}" > /dev/null 2>&1 || exit 1
          
          FILE_COUNT=$(find payload -type f | wc -l)
          echo "::add-mask::$FILE_COUNT"
          echo "Objetos en payload: $FILE_COUNT"

      - name: Process Media
        run: |
          process_file() {
            FILE="$1"
            NAME=$(basename "$FILE")
            BASE="${NAME%.*}"
            
            echo "::add-mask::$FILE"
            echo "::add-mask::$NAME"
            echo "::add-mask::$BASE"

            if ! ffprobe -v error "$FILE" > /dev/null 2>&1; then
              return 1
            fi

            ffmpeg -i "$FILE" -vf "scale=-2:720,format=yuv420p" -map 0 \
                   -c:v libx264 -preset faster -crf 23 -profile:v main -level 3.1 \
                   -c:a aac -b:a 128k -c:s copy \
                   "final/${BASE}_720p.mkv" > /dev/null 2>&1
          }
          
          export -f process_file
          
          find payload -type f | parallel --jobs $(nproc) process_file
          
          rm -rf payload/*
          PROCESSED_COUNT=$(find final -type f | wc -l)
          echo "::add-mask::$PROCESSED_COUNT"
          echo "Tarea completada. Disponibles: $PROCESSED_COUNT"

      - name: Zip Processed Files
        run: |
          if [ -z "$(ls -A final)" ]; then
            touch final/null
          fi
          cd final && zip -P "${{ secrets.ZIP_PASSWORD }}" -r ../test.zip . > /dev/null 2>&1
          cd .. && rm -rf final

      - name: Upload Processed Bundle
        uses: actions/upload-artifact@v4
        with:
          name: processed-bundle
          path: test.zip
          retention-days: 1
