name: Compile Mesa Amber Debug

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: alpine:latest
      options: --user root

    steps:
      - name: Install dependencies
        run: |
          apk add --no-cache \
            build-base meson ninja patch python3 py3-mako py3-packaging \
            pkgconf libdrm-dev libx11-dev libxdamage-dev libxshmfence-dev \
            libxxf86vm-dev libxrandr-dev wayland-dev wayland-protocols \
            zstd-dev elfutils-dev expat-dev bison flex curl tar xz

      - name: Download Mesa Amber
        run: |
          curl -L https://archive.mesa3d.org/older-versions/21.x/mesa-21.3.9.tar.xz -o mesa.tar.xz
          tar -xf mesa.tar.xz
          mv mesa-21.3.9 mesa-src

      - name: Create and Apply Patch (With Debug)
        run: |
          # Creamos el parche asegurando finales de línea Unix
          cat << 'EOF' > fix.patch
          --- a/meson.build
          +++ b/meson.build
          @@ -1008,12 +1008,15 @@
           has_mako = run_command(
             prog_python, '-c',
             '''
          -from distutils.version import StrictVersion
          +try:
          +  from packaging.version import Version
          +except:
          +  from distutils.version import StrictVersion as Version
           import mako
          -assert StrictVersion(mako.__version__) > StrictVersion("0.8.0")
          -  ''')
          +assert Version(mako.__version__) >= Version("0.8.0")
          +  ''', check: false)
           if has_mako.returncode() != 0
             error('Python (3.x) mako module >= 0.8.0 required to build mesa.')
           endif
          EOF
          
          echo ">>> Aplicando parche..."
          cd mesa-src
          if patch -Np1 -i ../fix.patch; then
            echo ">>> PARCHE APLICADO CON ÉXITO"
          else
            echo ">>> ERROR: EL PARCHE FALLÓ. Revisando diferencias en meson.build..."
            grep -C 5 "has_mako =" meson.build
            exit 1
          fi

      - name: Configure (Debug Mode)
        run: |
          cd mesa-src
          # Meson fallará aquí si faltan dependencias, mostramos el log solo si falla
          meson setup build \
            --prefix=/usr \
            -D amber=true \
            -D b_ndebug=true \
            -D dri-drivers=i915,i965 \
            -D dri3=enabled \
            -D egl=enabled \
            -D gallium-drivers=swrast \
            -D gbm=enabled \
            -D gles1=disabled \
            -D gles2=enabled \
            -D glvnd=true \
            -D glx=dri \
            -D llvm=disabled \
            -D platforms=x11,wayland \
            -D shared-glapi=enabled || (cat build/meson-logs/meson-log.txt && exit 1)

      - name: Compile and Package
        run: |
          cd mesa-src
          meson compile -C build
          mkdir -p ../output
          DESTDIR=$(pwd)/../output meson install -C build
          cd ../output
          tar -czf ../mesa-amber-binaries.tar.gz .

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: mesa-amber-bundle
          path: mesa-amber-binaries.tar.gz
