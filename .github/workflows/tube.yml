name: Build VacuumTube Alpine Musl

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: alpine:latest
      options: --user root

    steps:
      - name: Install Dependencies
        run: |
          echo "https://dl-cdn.alpinelinux.org/alpine/edge/main" >> /etc/apk/repositories
          echo "https://dl-cdn.alpinelinux.org/alpine/edge/community" >> /etc/apk/repositories
          echo "https://dl-cdn.alpinelinux.org/alpine/edge/testing" >> /etc/apk/repositories
          apk add --no-cache nodejs npm git electron bash asar

      - name: Clone VacuumTube
        run: |
          git clone https://github.com/shy1132/VacuumTube.git .
          npm install

      - name: Build with Custom Electron Dist
        run: |
          export ELECTRON_PATH="/usr/lib/electron"
          
          npx electron-builder --linux --dir \
            -c.electronDist=$ELECTRON_PATH \
            -c.electronVersion=39.2.7

      - name: Make it truly portable
        run: |
          # Copiamos las librerÃ­as de las que depende Electron al directorio del programa
          cp /usr/lib/libsimdutf.so* dist/linux-unpacked/
          cp /usr/lib/libicu* dist/linux-unpacked/ 2>/dev/null || true
          cp /usr/lib/libffmpeg.so* dist/linux-unpacked/ 2>/dev/null || true

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: VacuumTube-Alpine-Portable
          path: dist/linux-unpacked/
