name: Enviar url telegram

on:
  workflow_dispatch:
    inputs:
      download_url:
        description: 'Enlace directo al archivo a enviar (http/https)'
        required: true
        type: string
      filename:
        description: 'Nombre deseado del archivo local (ej. archivo.zip)'
        required: true
        type: string

jobs:
  enviar_a_telegram:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Descargar con aria2
      run: |
        sudo apt-get update && sudo apt-get install -y aria2
        aria2c "${{ inputs.download_url }}" \
          -o "${{ inputs.filename }}" \
          --max-connection-per-server=4 \
          --split=4 \
          --enable-rpc=false
        ls -lh "${{ inputs.filename }}"

    - name: ðŸ“ Evaluar tamaÃ±o
      id: sizecheck
      run: |
        SIZE=$(stat -c%s "${{ inputs.filename }}")
        echo "size=$SIZE" >> $GITHUB_OUTPUT
        echo "ðŸ“¦ TamaÃ±o del archivo: $SIZE bytes"

    - name: ðŸš€ Enviar directamente si < 50MB
      if: ${{ steps.sizecheck.outputs.size < 52428800 }}
      run: |
        curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendDocument" \
          -F chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -F caption="âœ… Archivo completo: ${{ inputs.filename }}" \
          -F document=@"${{ inputs.filename }}"

    - name: âœ‚ï¸ Dividir si excede 50MB
      if: ${{ steps.sizecheck.outputs.size >= 52428800 }}
      run: |
        split -b 49M "${{ inputs.filename }}" fragment_
        echo "ðŸ§© Fragmentos creados:"
        ls -lh fragment_*

    - name: ðŸš€ Enviar fragmentos
      if: ${{ steps.sizecheck.outputs.size >= 52428800 }}
      run: |
        i=1
        for f in fragment_*; do
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendDocument" \
            -F chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -F caption="ðŸ§© Fragmento $i de '${{ inputs.filename }}'" \
            -F document=@"$f"
          echo "âœ… Enviado fragmento $i â†’ $f"
          sleep 5
          ((i++))
        done