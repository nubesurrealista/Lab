name: Enviar url telegram

on:
  workflow_dispatch:
    inputs:
      download_url:
        description: 'Enlace directo al archivo a enviar (http/https)'
        required: true
        type: string
      filename:
        description: 'Nombre deseado del archivo local (ej. archivo.zip)'
        required: true
        type: string

jobs:
  enviar_a_telegram:
    runs-on: ubuntu-latest

    services:
      telegram-bot-api:
        image: telegrammessenger/telegram-bot-api
        ports:
          - 8081:8081
        options: >-
          --health-cmd "curl --fail http://localhost:8081 || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 3

    steps:
    - name: 📥 Descargar con aria2
      run: |
        sudo apt-get update && sudo apt-get install -y aria2
        aria2c "${{ inputs.download_url }}" \
          -o "${{ inputs.filename }}" \
          --max-connection-per-server=4 \
          --split=4 \
          --enable-rpc=false
        ls -lh "${{ inputs.filename }}"

    - name: 📏 Evaluar tamaño
      id: sizecheck
      run: |
        SIZE=$(stat -c%s "${{ inputs.filename }}")
        echo "size=$SIZE" >> $GITHUB_OUTPUT
        echo "📦 Tamaño del archivo: $SIZE bytes"

    - name: 🚀 Enviar archivo completo usando Bot API autohospedada
      run: |
        curl -s -X POST "http://localhost:8081/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendDocument" \
          -F chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -F caption="📦 Archivo completo: '${{ inputs.filename }}'" \
          -F document=@"${{ inputs.filename }}"
