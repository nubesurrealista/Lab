name: Build SRB2 Nativo Alpine

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: alpine:latest

    steps:
      - name: Configurar Entorno
        run: |
          echo "http://dl-cdn.alpinelinux.org/alpine/latest-stable/main" > /etc/apk/repositories
          echo "http://dl-cdn.alpinelinux.org/alpine/latest-stable/community" >> /etc/apk/repositories
          apk update
          apk add doas shadow bash
          mkdir -p /etc/doas.d
          echo "permit nopass root" > /etc/doas.d/doas.conf
          echo "USER=root" >> $GITHUB_ENV
          echo "HOME=/root" >> $GITHUB_ENV
          echo "TERM=xterm" >> $GITHUB_ENV

      - name: Instalar Dependencias
        run: |
          doas apk add make git which coreutils findutils file net-tools \
                       ncurses curl gawk stow fuse zlib-dev patchelf \
                       gdk-pixbuf build-base sdl2-dev libpng-dev \
                       libgme-dev libopenmpt-dev curl-dev mesa-dev glu-dev

      - name: Preparar srb2bld
        run: |
          git clone https://github.com/Bijman/srb2bld.git
          cd srb2bld
          doas make install

      - name: Compilar SRB2
        run: |
          export USER=root
          export HOME=/root
          addgroup -S docker || true
          # El primer \n salta el aviso de root, el 1 elige SRB2, los siguientes aceptan defaults
          printf "\n1\n1\nn\nn\n" | srb2bld --install --user

      - name: Exportar Binarios
        run: |
          mkdir -p ./dist
          [ -d "/root/.local/bin" ] && cp /root/.local/bin/srb2* ./dist/ || true
          find /root/srb2bld_builds/ -type f -executable -exec cp {} ./dist/ \; 2>/dev/null || true

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SRB2-Nativo-Alpine
          path: ./dist/
