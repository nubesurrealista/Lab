name: Build SRB2 on Alpine Linux

on:
  workflow_dispatch:

jobs:
  build-alpine:
    runs-on: ubuntu-latest
    container:
      image: alpine:latest

    steps:
      - name: Preparar entorno de usuario y doas
        run: |
          apk update
          # Instalamos shadow para tener 'useradd' y las dependencias de doas
          apk add doas shadow bash
          
          # Crear un archivo de configuración de doas válido
          echo "permit nopass root" > /etc/doas.d/doas.conf
          
          # Corregir el error "not a valid name" asegurando que root existe correctamente
          # y que el entorno tiene un nombre de usuario definido
          export USER=root
          export HOME=/root

      - name: Instalar dependencias oficiales de srb2bld
        run: |
          # Instalamos todo lo que listaste del README
          doas apk add make git which coreutils findutils file net-tools \
                       ncurses curl gawk docker stow fuse zlib patchelf \
                       gdk-pixbuf flatpak flatpak-builder

      - name: Clonar e instalar srb2bld
        run: |
          git clone https://github.com/Bijman/srb2bld.git
          cd srb2bld
          doas make install

      - name: Compilar SRB2 (Modo Automático)
        run: |
          export TERM=xterm
          export USER=root
          export HOME=/root
          
          # Usamos la opción -s para saltar la instalación de dependencias 
          # ya que las instalamos manualmente arriba, evitando el error de 'passwd'
          # Intentamos la compilación de SRB2 (opción 1)
          yes "" | srb2bld --appimage || printf "1\n\n\n\nn\n" | srb2bld
          
      - name: Subir resultados
        uses: actions/upload-artifact@v4
        with:
          name: SRB2-Alpine-Build
          path: /root/srb2bld_builds/ # Carpeta por defecto de srb2bld
