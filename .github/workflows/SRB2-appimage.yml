name: Build SRB2 Nativo (Alpine)

on:
  workflow_dispatch:

jobs:
  build-native:
    runs-on: ubuntu-latest
    container:
      image: alpine:latest

    steps:
      - name: Preparar Entorno (doas y variables)
        run: |
          apk update
          apk add doas shadow bash
          
          # Configuración de doas sin contraseña para root
          mkdir -p /etc/doas.d
          echo "permit nopass root" > /etc/doas.d/doas.conf
          
          # Variables de entorno críticas para evitar errores de passwd/user
          echo "USER=root" >> $GITHUB_ENV
          echo "HOME=/root" >> $GITHUB_ENV

      - name: Instalar Dependencias del README
        run: |
          doas apk add make git which coreutils findutils file net-tools \
                       ncurses curl gawk stow fuse zlib patchelf \
                       gdk-pixbuf bash build-base SDL2-dev libpng-dev \
                       libgme-dev libopenmpt-dev curl-dev

      - name: Clonar e Instalar srb2bld
        run: |
          git clone https://github.com/Bijman/srb2bld.git
          cd srb2bld
          doas make install

      - name: Compilación Nativa de SRB2
        run: |
          export TERM=xterm
          # 1: SRB2
          # 1: Build nativa (64-bit)
          # n: No instalar en el sistema (solo queremos el binario)
          # n: No crear acceso directo
          printf "1\n1\nn\nn\n" | srb2bld

      - name: Recolectar Binarios Nativos
        run: |
          mkdir -p ./dist
          # srb2bld guarda las compilaciones nativas en subcarpetas dentro de builds
          find /root/srb2bld_builds/ -type f -executable -exec cp {} ./dist/ \;
          
      - name: Subir Binarios
        uses: actions/upload-artifact@v4
        with:
          name: SRB2-Nativo-Alpine
          path: ./dist/
