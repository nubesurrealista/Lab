name: Build lsd for Android ARMv7

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: armv7-linux-androideabi

      - name: Install cargo-ndk
        run: cargo install cargo-ndk --locked

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: setup-ndk
        with:
          ndk-version: r26d
          add-to-path: true
          local-cache: true

      - name: Clone lsd repository
        run: |
          git clone https://github.com/lsd-rs/lsd.git
          cd lsd
          # Puedes cambiar a un tag específico si prefieres estabilidad
          # git checkout v0.23.1   # Ejemplo: última estable conocida en 2025
          # Por defecto usamos main (últimos cambios)

      - name: Build lsd for Android ARMv7
        working-directory: lsd
        env:
          RUSTFLAGS: "-C target-feature=+crt-static -C opt-level=s"
          # opt-level=s → optimiza para tamaño (binario más pequeño)
          CARGO_PROFILE_RELEASE_LTO: "thin"
          CARGO_PROFILE_RELEASE_CODEGEN_UNITS: "16"
        run: |
          cargo ndk \
            -t armeabi-v7a \
            build --release --locked

          # Verifica el binario
          ls -la target/armv7-linux-androideabi/release/lsd
          file target/armv7-linux-androideabi/release/lsd

      - name: Strip the binary (reduce size)
        working-directory: lsd
        run: |
          ${ANDROID_NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip \
            target/armv7-linux-androideabi/release/lsd || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: lsd-android-armv7
          path: lsd/target/armv7-linux-androideabi/release/lsd
          if-no-files-found: error
          retention-days: 1
